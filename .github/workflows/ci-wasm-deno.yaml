name: CI WASM Deno

on:
  push:
    branches: [main]
    paths:
      - 'crates/kreuzberg/**'
      - 'crates/kreuzberg-wasm/**'
      - 'crates/kreuzberg-core-types/**'
      - 'e2e/wasm-deno/**'
      - 'tools/e2e-generator/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'pnpm-lock.yaml'
      - 'package.json'
      - '.github/actions/install-system-deps/**'
      - '.github/actions/setup-rust/**'
      - '.github/actions/setup-node-workspace/**'
      - '.github/workflows/ci-wasm-deno.yaml'
  pull_request:
    branches: [main]
    paths:
      - 'crates/kreuzberg/**'
      - 'crates/kreuzberg-wasm/**'
      - 'crates/kreuzberg-core-types/**'
      - 'e2e/wasm-deno/**'
      - 'tools/e2e-generator/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'pnpm-lock.yaml'
      - 'package.json'
      - '.github/actions/install-system-deps/**'
      - '.github/actions/setup-rust/**'
      - '.github/actions/setup-node-workspace/**'
      - '.github/workflows/ci-wasm-deno.yaml'

concurrency:
  group: ci-wasm-deno-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  RUST_BACKTRACE: short
  RUST_MIN_STACK: 16777216

jobs:
  build-wasm-deno:
    name: Build WASM for Deno (${{ matrix.os }}, Deno ${{ matrix.deno-version }})
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            deno-version: "1.x"
          - os: ubuntu-latest
            deno-version: "2.x"
          - os: macos-latest
            deno-version: "1.x"
          - os: macos-latest
            deno-version: "2.x"
          - os: windows-latest
            deno-version: "1.x"
          - os: windows-latest
            deno-version: "2.x"
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: wasm-deno-${{ matrix.os }}
          target: wasm32-unknown-unknown

      - name: Setup Node (for wasm-pack and build tools)
        uses: ./.github/actions/setup-node-workspace

      - name: Install wasm-pack
        shell: bash
        run: |
          curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Install Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: ${{ matrix.deno-version }}

      - name: Build WASM package
        shell: bash
        run: |
          cd crates/kreuzberg-wasm
          pnpm run build:wasm:bundler

      - name: Build TypeScript wrapper
        shell: bash
        run: |
          cd crates/kreuzberg-wasm
          pnpm run build:ts

      - name: Generate Deno E2E tests
        shell: bash
        run: |
          cargo run -p kreuzberg-e2e-generator -- generate --lang wasm-deno --fixtures fixtures --output e2e

      - name: Link WASM package for testing
        shell: bash
        run: |
          cd crates/kreuzberg-wasm
          pnpm pack
          WASM_PKG_PATH="$(pwd)/$(ls kreuzberg-wasm-*.tgz)"
          echo "WASM_PKG_PATH=$WASM_PKG_PATH" >> "$GITHUB_ENV"

      - name: Install WASM package in Deno tests
        shell: bash
        run: |
          cd e2e/wasm-deno
          # Deno uses npm specifiers, so we'll rely on the import map in deno.json
          echo "Using WASM package from: $WASM_PKG_PATH"

      - name: Run Deno tests
        shell: bash
        run: |
          cd e2e/wasm-deno
          deno task test

      - name: Cleanup Rust cache
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

  verify-wasm-size:
    name: Verify WASM Bundle Size
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: wasm-size
          target: wasm32-unknown-unknown

      - name: Setup Node
        uses: ./.github/actions/setup-node-workspace

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM (release optimized)
        run: |
          cd crates/kreuzberg-wasm
          pnpm run build:wasm:bundler

      - name: Check WASM file sizes
        run: |
          cd crates/kreuzberg-wasm/pkg/bundler
          WASM_SIZE=$(wc -c < kreuzberg_wasm_bg.wasm)
          echo "WASM size: $(numfmt --to=iec-i --suffix=B "$WASM_SIZE")"

          # Verify size is under 10MB (uncompressed)
          if [ "$WASM_SIZE" -gt 10485760 ]; then
            echo "ERROR: WASM bundle is too large: $WASM_SIZE bytes (max: 10485760)"
            exit 1
          fi

          # Check compressed size
          gzip -c kreuzberg_wasm_bg.wasm > kreuzberg_wasm_bg.wasm.gz
          GZIP_SIZE=$(wc -c < kreuzberg_wasm_bg.wasm.gz)
          echo "WASM size (gzip): $(numfmt --to=iec-i --suffix=B "$GZIP_SIZE")"

          if [ "$GZIP_SIZE" -gt 3145728 ]; then
            echo "WARNING: Gzipped WASM is larger than 3MB: $GZIP_SIZE bytes"
          fi

      - name: Cleanup Rust cache
        if: always()
        uses: ./.github/actions/cleanup-rust-cache
