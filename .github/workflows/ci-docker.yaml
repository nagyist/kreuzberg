name: CI Docker Build & Test

on:
  workflow_run:
    workflows: ["Publish Release"]
    types: [completed]
  push:
    branches: [main]
    paths:
      - '.github/actions/**'
      - '.github/workflows/ci-docker.yaml'
      - 'crates/kreuzberg/**'
      - 'crates/kreuzberg-cli/**'
      - 'crates/kreuzberg-tesseract/**'
      - 'docker/**'
      - '.dockerignore'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.cargo/config.toml'
      - 'scripts/ci/docker/**'
  pull_request:
    branches: [main]
    paths:
      - '.github/actions/**'
      - '.github/workflows/ci-docker.yaml'
      - 'crates/kreuzberg/**'
      - 'crates/kreuzberg-cli/**'
      - 'crates/kreuzberg-tesseract/**'
      - 'docker/**'
      - '.dockerignore'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.cargo/config.toml'
      - 'scripts/ci/docker/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip feature tests (build only)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ORT_VERSION: "1.23.2"

jobs:
  test-docker:
    name: Build and Test Docker Image (${{ matrix.variant }})
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: read

    strategy:
      fail-fast: true
      matrix:
        variant:
          - core
          - full

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        shell: bash
        run: scripts/ci/docker/free-disk-space.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.${{ matrix.variant }}
          push: false
          load: true
          tags: kreuzberg:${{ matrix.variant }}
          build-args: |
            ONNXRUNTIME_VERSION=${{ env.ORT_VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max,scope=ci-docker-${{ matrix.variant }}

      - name: Test Docker image size
        shell: bash
        run: scripts/ci/docker/check-image-size.sh "${{ matrix.variant }}"

      - name: Run comprehensive feature tests
        if: ${{ !inputs.skip_tests }}
        run: scripts/ci/docker/run-feature-tests.sh "${{ matrix.variant }}"

      - name: Run configuration tests
        if: ${{ !inputs.skip_tests }}
        run: scripts/ci/docker/run-config-tests.sh "${{ matrix.variant }}"

      - name: Save Docker image as artifact
        if: success()
        shell: bash
        run: scripts/ci/docker/save-image.sh "${{ matrix.variant }}" /tmp

      - name: Upload Docker image artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.variant }}
          path: /tmp/kreuzberg-${{ matrix.variant }}.tar.gz
          retention-days: 7
          compression-level: 0

      - name: Upload test results
        if: always() && !inputs.skip_tests && hashFiles('/tmp/kreuzberg-docker-test-results.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: docker-test-results-${{ matrix.variant }}
          path: /tmp/kreuzberg-docker-test-results.json
          retention-days: 7

      - name: Collect Docker logs on failure
        if: failure()
        shell: bash
        run: scripts/ci/docker/collect-logs.sh /tmp/docker-logs

      - name: Upload Docker logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-logs-${{ matrix.variant }}
          path: /tmp/docker-logs/
          retention-days: 7

      - name: Clean up Docker resources
        if: always()
        shell: bash
        run: scripts/ci/docker/cleanup.sh "${{ matrix.variant }}"

      - name: Summary
        if: success()
        shell: bash
        run: scripts/ci/docker/summary.sh "${{ matrix.variant }}" /tmp/kreuzberg-docker-test-results.json

  # Test PyPI wheel installation on various Linux distributions
  # This catches glibc compatibility issues like #326
  test-pypi-wheel:
    name: Test PyPI Wheel (${{ matrix.os }}, ${{ matrix.image }})
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          # x86_64 tests
          - os: ubuntu-latest
            image: python:3.10-slim-bookworm
            platform: linux/amd64
            arch: x86_64
          - os: ubuntu-latest
            image: python:3.12-slim-bookworm
            platform: linux/amd64
            arch: x86_64
          - os: ubuntu-latest
            image: python:3.13-slim-bookworm
            platform: linux/amd64
            arch: x86_64
          # ARM64 tests (catches glibc compatibility issues like #326)
          - os: ubuntu-24.04-arm
            image: python:3.10-slim-bookworm
            platform: linux/arm64
            arch: aarch64
          - os: ubuntu-24.04-arm
            image: python:3.12-slim-bookworm
            platform: linux/arm64
            arch: aarch64
          - os: ubuntu-24.04-arm
            image: python:3.13-slim-bookworm
            platform: linux/arm64
            arch: aarch64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test PyPI wheel installation
        shell: bash
        run: |
          echo "=== Testing kreuzberg PyPI wheel on ${{ matrix.image }} (${{ matrix.arch }}) ==="

          # Create test script
          cat > /tmp/test_wheel.py << 'PYTEST'
          import sys
          print(f"Python version: {sys.version}")

          try:
              import kreuzberg
              print(f"kreuzberg version: {kreuzberg.__version__}")

              # Basic functionality test
              from kreuzberg import ExtractionConfig
              config = ExtractionConfig()
              print(f"ExtractionConfig created successfully")

              print("✅ All tests passed!")
              sys.exit(0)
          except Exception as e:
              print(f"❌ Test failed: {e}")
              sys.exit(1)
          PYTEST

          # Run the test in Docker container
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v /tmp/test_wheel.py:/test_wheel.py:ro \
            ${{ matrix.image }} \
            bash -c "
              set -e
              echo '>>> Installing kreuzberg from PyPI...'
              pip install --no-cache-dir kreuzberg
              echo '>>> Running tests...'
              python /test_wheel.py
            "

      - name: Test wheel platform tags
        shell: bash
        run: |
          echo "=== Checking wheel platform compatibility ==="

          docker run --rm \
            --platform ${{ matrix.platform }} \
            ${{ matrix.image }} \
            bash -c "
              set -e
              echo '>>> System info:'
              uname -m
              cat /etc/os-release | grep -E '^(NAME|VERSION)='
              ldd --version 2>&1 | head -1 || true

              echo ''
              echo '>>> Available kreuzberg wheels:'
              pip index versions kreuzberg 2>/dev/null || pip install kreuzberg --dry-run -v 2>&1 | grep -E 'kreuzberg.*\.whl' | head -5 || true
            "
